# 防控主機探索報告

> **日期**: 2025-12-23  
> **目標**: 建立 SSH 連線並分析房控系統 XML 格式

---

## 📋 探索摘要

成功連線到防控主機 (192.168.8.23)，發現：
- 房控系統使用兩種 XML 格式傳輸資料
- `a6gw_file.exe` 透過 Oracle 連線 (`gdwuukt`) 與 PMS 同步
- 每日產生數百筆 XML 房態查詢記錄

---

## 🖥️ 防控主機資訊

| 項目 | 值 |
|:-----|:---|
| **IP** | 192.168.8.23 |
| **電腦名稱** | DESKTOP-N7PQUIH |
| **作業系統** | Windows 10 (19045.6466) |
| **SSH 使用者** | USER |
| **認證方式** | ✅ 公鑰認證 (免密碼) |

---

## 🏗️ 房控系統架構

### 運行中程式 (2025-12-23 確認)

| 程式 | 記憶體 | 說明 |
|:-----|:-----|:-----|
| `RmsServer.exe` | 19 MB | 房控伺服器，接收感應器訊號 |
| `PMSDB.exe` | 22 MB | 連線 PMS 資料庫 (192.168.8.3) |
| `app_a6gw_file.exe` | 54 MB | XML 處理，同步到 Oracle |
| `athena_watchdog_x64.exe` | 25 MB x3 | 監控程式 |
| `athena_chk_alive_file.exe` | 14 MB | 健康檢查 |
| `athena_del.exe` | 23 MB x3 | 舊檔案清理 |

### Athena 程式功能

| 程式 | 功能 |
|:-----|:-----|
| `hotel.exe` | PMS 主程式 (前台管理) |
| `pbx.exe` | 電話系統整合 |
| `app_websync.exe` | 網站訂房同步 |
| `wrs_rece_msg.exe` | WebSync 訊息接收 |
| `athena_tv.exe` | 電視系統整合 |
| `ele_uninv.exe` | 電子發票 |
| `app_export.exe` | 資料匯出 |
| `app_imp_rs.exe` | 資料匯入 (RS) |

### Athena 系統目錄結構

| 目錄 | 說明 |
|:-----|:-----|
| `C:\Athena\a6gw_file\` | XML 處理程式 |
| `C:\Athena\pgm12\` | **德安 PMS 前端程式 (完整)** |
| `C:\Athena\CHECK_VER\` | 版本檢查/自動更新程式 |
| `C:\Athena\app_chk_alive_file\` | 健康檢查程式 |
| `C:\Athena\wrs_log\` | WebSync 日誌 |
| `C:\Athena\XDEL\` | 舊檔案清理工具 |
| `C:\hotelmdb\` | Access MDB 本地資料庫 |
| `C:\xml_log\` | XML 處理日誌 (每日約 500KB) |
| `C:\app\product\12.2.0\` | **Oracle 12c 客戶端** |

### 資料庫連線設定

#### 主要連線 (frame.ini / env.ini)

```ini
DBMS=O10 Oracle10g (10.1.0)
ServerName=gdwuukt
LogId=gdwuukt
LogPassword=sql
vendor=oracle
```

#### 帳號清單

| 帳號 | 密碼 | 用途 | 來源 |
|:-----|:-----|:-----|:-----|
| `gdwuukt` | `sql` | Athena 主程式 | frame.ini |
| `AISPGM` | `sql` | 版本更新程式 | memo.ini |
| `web_gdwuukt` | - | WebSync (WRS) | wrs_log |
| `htc520_a6gw` | `sql` | 資料匯入 | app_imp_psi.ini |
| `miramar` | `sql` | WebSync | app_websync.ini |

#### 其他連線

| 設定檔 | ServerName | LogId | 用途 |
|:-----|:-----|:-----|:-----|
| `app_websync.ini` | tco10gutf8 | miramar | WebSync |
| `owrs_sch_env.ini` | gdwuukt | gdwuukt | 排程器 |

### 資料流

```
房間感應器
    ↓
RmsServer.exe (接收訊號，產生 XML)
    ↓
C:\room\ (XML 檔案目錄)
    ↓
a6gw_file.exe (讀取 XML，查詢/寫入 Oracle)
    ↓
192.168.8.3 Oracle DB (gdwuukt)
```

---

## 📂 XML 檔案結構

### 目錄

| 目錄 | 用途 |
|:-----|:-----|
| `C:\room\client\` | 待處理的 XML |
| `C:\room\processed\` | 已處理的 XML (約 2000+ 檔案) |
| `C:\room\log\` | 日誌檔案 (每日約 2MB) |

### 檔案命名規則

- **請求檔**: `C04306XXX.xml`
- **回應檔**: `C04306XXX_ret.xml`
- **歷史備份**: `C00000001.xml.XXXXXX`

---

## 📝 XML 格式

### 類型 1: 房態查詢 (ROOM_INF)

每日凌晨輪詢所有房間 (約 50 間)

**請求檔案**:
```xml
<?xml version="1.0"?>
<ROWSET><ROW>
  <REVE-CODE>0300811090</REVE-CODE>
  <ACTION_COD>ROOM_INF</ACTION_COD>
  <ROOM_NOS>616</ROOM_NOS>
  <ACTION_DAT>2025/12/23 00:31:32</ACTION_DAT>
</ROW></ROWSET>
```

**回應檔案**:
```xml
<?xml version="1.0"?>
<ROWSET><ROW>
  <SEND-CODE>0300811090</SEND-CODE>
  <ACTION_COD>ROOM_INF</ACTION_COD>
  <ROOM_NOS>616</ROOM_NOS>
  <ROOM_STA>V</ROOM_STA>
  <ADVBAL_AMT>0</ADVBAL_AMT>
  <CCARD_AMT>0</CCARD_AMT>
  <ACTION_DAT>2025/12/23 00:31:36</ACTION_DAT>
  <RETN-CODE>0000</RETN-CODE>
  <RETN-CODE-DESC>OK</RETN-CODE-DESC>
</ROW></ROWSET>
```

### 類型 2: 感應器狀態碼

房間感應器直接傳送狀態位元碼：

```xml
<?xml version="1.0"?>
<ROWSET><ROW>
  <REVE-CODE>0300814190</REVE-CODE>
  <ROOM_NOS>610</ROOM_NOS>
  <ACTION_COD>#ROOM_STA#0111001100100000#</ACTION_COD>
  <ACTION_STA>1</ACTION_STA>
  <ACTION_DAT>2024/04/30 17:40:51</ACTION_DAT>
</ROW></ROWSET>
```

> **位元碼解析** (待確認)：`0111001100100000` 可能代表各感應器狀態

---

## 🏷️ 狀態碼對照表

### ROOM_STA (房間狀態)

| 代碼 | 說明 | 備註 |
|:-----|:-----|:-----|
| **V** | 空房 (Vacant) | 可售 |
| **R** | 維修房 (Repair) | 不可售 |
| **O** | 已佔用 (Occupied) | 待確認 |

### RETN-CODE (回應代碼)

| 代碼 | 說明 |
|:-----|:-----|
| **0000** | 成功 (OK) |

---

## 📊 日誌檔案格式

### 每日處理日誌 (MMDD.log)

- 格式：`時間 動作 檔案名 結果`
- 例：`08:33 process C04306290.xml`、`08:33 結果:Process Successful`

### 接收日誌 (YYYYMMDD_receive.log)

```xml
<rece_log>
  <ins_dat>2025/12/23 08:33:56</ins_dat>
  <hotel_cod>xxx</hotel_cod>
  <process_cod>INF</process_cod>
  <rece_sta>I</rece_sta>
  <action>INF</action>
</rece_log>
```

---

## 🔍 指定執行檔深入分析

### 1. `check_ver.exe` (德安 PMS 啟動器)
- **路徑**: `C:\Athena\CHECK_VER\check_ver.exe`
- **功能**: **PMS 客戶端啟動與自動更新程式**。它會檢查版本更新，然後啟動 `hotel.exe` (主程式)。
- **關鍵資料**:
  - 設定檔: `memo.ini`
  - 資料庫帳號: `AISPGM` / `sql` (Oracle)
  - 啟動目標: `C:\Athena\pgm12\hotel.exe`

### 2. `athena_watchdog_x64.exe` (系統看門狗)
- **路徑**: `C:\Athena\athena_watchdog\athena_watchdog_x64.exe`
- **功能**: **系統監控服務**。負責監控關鍵程式是否存活，若崩潰則自動重啟。
- **監控對象** (從 ini 確認):
  - `athena_chk_alive_file.exe` (健康檢查)
  - `app_a6gw_file.exe` (房控 XML 同步)
- **可用資料**:
  - `restart_watchdog_log.txt`: 程式崩潰與重啟的歷史記錄，可用於診斷系統穩定性。

### 3. `HotelViewClient.exe` (房態監控)
- **路徑**: `C:\Program Files (x86)\HotelViewClient\HotelViewClient.exe`
- **功能**: **房態視覺化監控端**。提供圖形化介面顯示房間狀態 (如 R/V 狀態)。
- **技術細節**:
  - 使用 `RmsClient.dll`: 推測直接與 `RmsServer.exe` 通訊。
  - 本地無設定檔: 可能透過 Registry 或與 Server 同目錄的設定運作。

### 4. `AppMgrPx.exe` (NEC PBX 管理)
- **路徑**: `C:\Program Files (x86)\NEC\SL2100 PC Pro\AppMgrPx.exe`
- **功能**: **NEC SL2100 電話總機管理工具** (PC Pro)。
- **用途**: 用於設定飯店的電話交換機 (分機設定、計費費率等)。
- **關聯**: 雖不直接提供房態，但它管理的硬體 (PBX) 透過 `pbx.exe` 與 Athena PMS 整合 (見 `pbx.ini`)。

---

## ⏭️ 後續待辦

- [x] 設定 SSH 公鑰認證 (免密碼登入) ✅ 2025-12-23
- [x] 探索 Athena 系統目錄結構 ✅ 2025-12-23
- [x] 分析 XML 格式與狀態碼 ✅ 2025-12-23
- [x] 探索德安 PMS 客戶端 (CHECK_VER, hotelmdb, Oracle 12c) ✅ 2025-12-23
- [ ] 確認位元碼 `#ROOM_STA#XXXXXXXX#` 各位意義
- [ ] 開發 Python 腳本監控 `C:\room\` 新 XML
- [ ] 整合房控訊號至 LINE Bot / Admin Dashboard

---

## 📎 附錄：PMS 同步設定 (XMLCFG.txt)

```ini
pmsconnyn=y              # 啟用 PMS 連線
workpath=c:\room         # XML 工作目錄
mypath=c:\hotelmdb       # 本地 MDB 資料庫路徑
logpath=c:\xml_log       # 日誌路徑
firstPMSyn=y             # 啟動時查詢 PMS
autoyn=y                 # 啟用自動同步
autotime=30              # 同步間隔 30 秒
```
