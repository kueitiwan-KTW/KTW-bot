<!-- ç•™è¨€æ¿çµ„ä»¶ -->
<div id="messageBoard" class="message-board collapsed">
    <div class="message-board-header" onclick="toggleMessageBoard()">
        <span>ğŸ“‹ ç•™è¨€æ¿</span>
        <span id="pendingCount" class="badge">0</span>
        <button class="toggle-btn">â–¼</button>
    </div>

    <div class="message-board-content">
        <!-- æ–°å¢ç•™è¨€æŒ‰éˆ• -->
        <button class="btn-add-message" onclick="showAddMessageForm()">
            â• æ–°å¢ç•™è¨€
        </button>

        <!-- æ–°å¢ç•™è¨€è¡¨å–® -->
        <div id="addMessageForm" class="add-message-form" style="display: none;">
            <input type="text" id="messageTitle" placeholder="æ¨™é¡Œ" class="form-input">
            <textarea id="messageContent" placeholder="å…§å®¹ï¼ˆé¸å¡«ï¼‰" class="form-textarea"></textarea>
            <div class="form-row">
                <select id="messagePriority" class="form-select">
                    <option value="low">ğŸŸ¢ ä¸€èˆ¬</option>
                    <option value="medium" selected>ğŸŸ¡ é‡è¦</option>
                    <option value="high">ğŸ”´ ç·Šæ€¥</option>
                </select>
                <input type="text" id="messageCreator" placeholder="æ‚¨çš„åå­—" class="form-input" style="flex: 1;">
            </div>
            <div class="form-actions">
                <button class="btn-save" onclick="addMessage()">å„²å­˜</button>
                <button class="btn-cancel" onclick="hideAddMessageForm()">å–æ¶ˆ</button>
            </div>
        </div>

        <!-- ç•™è¨€åˆ—è¡¨ -->
        <div id="messageList" class="message-list">
            <!-- å‹•æ…‹è¼‰å…¥ -->
        </div>
    </div>
</div>

<style>
    /* ç•™è¨€æ¿æ¨£å¼ */
    .message-board {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 350px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        transition: all 0.3s ease;
        max-height: 600px;
        display: flex;
        flex-direction: column;
    }

    .message-board.collapsed {
        max-height: 50px;
    }

    .message-board-header {
        padding: 12px 16px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px 12px 0 0;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        user-select: none;
    }

    .message-board.collapsed .message-board-header {
        border-radius: 12px;
    }

    .message-board-header .badge {
        background: rgba(255, 255, 255, 0.3);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 12px;
        font-weight: bold;
    }

    .toggle-btn {
        margin-left: auto;
        background: none;
        border: none;
        color: white;
        font-size: 12px;
        cursor: pointer;
        transition: transform 0.3s;
    }

    .message-board.collapsed .toggle-btn {
        transform: rotate(-90deg);
    }

    .message-board-content {
        padding: 16px;
        overflow-y: auto;
        flex: 1;
        display: none;
    }

    .message-board:not(.collapsed) .message-board-content {
        display: block;
    }

    /* æ–°å¢æŒ‰éˆ• */
    .btn-add-message {
        width: 100%;
        padding: 10px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        margin-bottom: 12px;
        transition: all 0.3s;
    }

    .btn-add-message:hover {
        background: #5568d3;
        transform: translateY(-1px);
    }

    /* æ–°å¢è¡¨å–® */
    .add-message-form {
        background: #f8f9ff;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 12px;
    }

    .form-input,
    .form-textarea,
    .form-select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 6px;
        margin-bottom: 8px;
        font-size: 13px;
    }

    .form-textarea {
        resize: vertical;
        min-height: 60px;
    }

    .form-row {
        display: flex;
        gap: 8px;
    }

    .form-actions {
        display: flex;
        gap: 8px;
    }

    .btn-save,
    .btn-cancel {
        flex: 1;
        padding: 8px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
    }

    .btn-save {
        background: #28a745;
        color: white;
    }

    .btn-save:hover {
        background: #218838;
    }

    .btn-cancel {
        background: #e0e0e0;
        color: #666;
    }

    .btn-cancel:hover {
        background: #ccc;
    }

    /* ç•™è¨€åˆ—è¡¨ */
    .message-list {
        max-height: 350px;
        overflow-y: auto;
    }

    .message-item {
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 10px;
        transition: all 0.2s;
        position: relative;
    }

    .message-item:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .message-item.priority-high {
        border-color: #dc3545;
        border-left-width: 4px;
    }

    .message-item.priority-medium {
        border-color: #ffc107;
        border-left-width: 4px;
    }

    .message-item.priority-low {
        border-color: #28a745;
        border-left-width: 4px;
    }

    .message-item.completed {
        opacity: 0.6;
        background: #f5f5f5;
    }

    .message-header {
        display: flex;
        align-items: start;
        gap: 8px;
        margin-bottom: 6px;
    }

    .message-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
        flex-shrink: 0;
        margin-top: 2px;
    }

    .message-title {
        flex: 1;
        font-weight: 500;
        font-size: 14px;
        color: #333;
    }

    .message-item.completed .message-title {
        text-decoration: line-through;
        color: #999;
    }

    .message-delete {
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        font-size: 16px;
        padding: 0 4px;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .message-item:hover .message-delete {
        opacity: 1;
    }

    .message-delete:hover {
        color: #c82333;
    }

    .message-content {
        font-size: 13px;
        color: #666;
        margin: 6px 0 6px 26px;
        line-height: 1.4;
    }

    .message-meta {
        font-size: 11px;
        color: #999;
        margin-left: 26px;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #999;
    }

    .empty-state-icon {
        font-size: 48px;
        margin-bottom: 10px;
    }
</style>

<script>
    // ç•™è¨€æ¿åŠŸèƒ½
    let messagesData = [];
    let isCollapsed = true;

    // åˆ‡æ›ç•™è¨€æ¿
    function toggleMessageBoard() {
        const board = document.getElementById('messageBoard');
        isCollapsed = !isCollapsed;

        if (isCollapsed) {
            board.classList.add('collapsed');
        } else {
            board.classList.remove('collapsed');
        }
    }

    // è¼‰å…¥ç•™è¨€
    async function loadMessages() {
        try {
            const response = await fetch('/api/messages');
            const data = await response.json();

            if (data.status === 'success') {
                messagesData = data.messages;
                document.getElementById('pendingCount').textContent = data.pending_count;
                renderMessages();
            }
        } catch (error) {
            console.error('è¼‰å…¥ç•™è¨€å¤±æ•—:', error);
        }
    }

    // æ¸²æŸ“ç•™è¨€åˆ—è¡¨
    function renderMessages() {
        const listEl = document.getElementById('messageList');

        if (messagesData.length === 0) {
            listEl.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“</div>
                <p>ç›®å‰æ²’æœ‰ç•™è¨€</p>
            </div>
        `;
            return;
        }

        const html = messagesData.map(msg => `
        <div class="message-item priority-${msg.priority} ${msg.completed ? 'completed' : ''}">
            <div class="message-header">
                <input type="checkbox" class="message-checkbox" 
                       ${msg.completed ? 'checked' : ''}
                       onchange="toggleComplete('${msg.id}')">
                <div class="message-title">${escapeHtml(msg.title)}</div>
                <button class="message-delete" onclick="deleteMessage('${msg.id}')" title="åˆªé™¤">âœ•</button>
            </div>
            ${msg.content ? `<div class="message-content">${escapeHtml(msg.content)}</div>` : ''}
            <div class="message-meta">
                ${formatTime(msg.created_at)} â€¢ ${msg.created_by}
            </div>
        </div>
    `).join('');

        listEl.innerHTML = html;
    }

    // é¡¯ç¤ºæ–°å¢è¡¨å–®
    function showAddMessageForm() {
        document.getElementById('addMessageForm').style.display = 'block';
        document.getElementById('messageTitle').focus();
    }

    // éš±è—æ–°å¢è¡¨å–®
    function hideAddMessageForm() {
        document.getElementById('addMessageForm').style.display = 'none';
        document.getElementById('messageTitle').value = '';
        document.getElementById('messageContent').value = '';
        document.getElementById('messagePriority').value = 'medium';
    }

    // æ–°å¢ç•™è¨€
    async function addMessage() {
        const title = document.getElementById('messageTitle').value.trim();
        const content = document.getElementById('messageContent').value.trim();
        const priority = document.getElementById('messagePriority').value;
        const creator = document.getElementById('messageCreator').value.trim() || 'ä½¿ç”¨è€…';

        if (!title) {
            alert('è«‹è¼¸å…¥æ¨™é¡Œ');
            return;
        }

        try {
            const response = await fetch('/api/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    type: 'todo',
                    priority: priority,
                    title: title,
                    content: content,
                    created_by: creator
                })
            });

            const data = await response.json();

            if (data.status === 'success') {
                hideAddMessageForm();
                loadMessages();
            } else {
                alert('æ–°å¢å¤±æ•—ï¼š' + data.error);
            }
        } catch (error) {
            alert('æ–°å¢éŒ¯èª¤ï¼š' + error);
        }
    }

    // åˆ‡æ›å®Œæˆç‹€æ…‹
    async function toggleComplete(msgId) {
        try {
            const response = await fetch(`/api/messages/${msgId}/complete`, {
                method: 'PUT'
            });

            const data = await response.json();

            if (data.status === 'success') {
                loadMessages();
            }
        } catch (error) {
            console.error('æ›´æ–°å¤±æ•—:', error);
        }
    }

    // åˆªé™¤ç•™è¨€
    async function deleteMessage(msgId) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡ç•™è¨€ï¼Ÿ')) return;

        try {
            const response = await fetch(`/api/messages/${msgId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (data.status === 'success') {
                loadMessages();
            }
        } catch (error) {
            console.error('åˆªé™¤å¤±æ•—:', error);
        }
    }

    // å·¥å…·å‡½æ•¸
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatTime(isoString) {
        const date = new Date(isoString);
        const now = new Date();
        const diff = now - date;

        if (diff < 60000) return 'å‰›å‰›';
        if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é˜å‰';
        if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ™‚å‰';
        if (diff < 604800000) return Math.floor(diff / 86400000) + 'å¤©å‰';

        return date.toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' });
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        loadMessages();
        // æ¯30ç§’è‡ªå‹•åˆ·æ–°
        setInterval(loadMessages, 30000);
    });
</script>