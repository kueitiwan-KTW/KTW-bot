<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="title">å…¥ä½å®¢äººç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* å°èˆªåˆ— */
        .nav-bar {
            background: white;
            padding: 15px 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
        }

        .nav-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            text-decoration: none;
            color: #666;
            background: #f5f5f5;
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .nav-btn:hover:not(.active) {
            background: #e0e0e0;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header h1 {
            color: #333;
            font-size: 32px;
        }

        .current-date {
            color: #666;
            margin-top: 5px;
            font-size: 16px;
        }

        /* èªè¨€åˆ‡æ›å™¨ */
        .lang-switcher {
            display: flex;
            gap: 10px;
            background: #f5f5f5;
            padding: 5px;
            border-radius: 25px;
        }

        .lang-btn {
            padding: 8px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            color: #666;
        }

        .lang-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .lang-btn:hover:not(.active) {
            background: #e0e0e0;
        }

        /* æ—¥æœŸé¸æ“‡å™¨ */
        .date-selector {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .date-selector::-webkit-scrollbar {
            height: 6px;
        }

        .date-selector::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 3px;
        }

        .date-btn {
            min-width: 120px;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            cursor: pointer;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            color: #666;
            text-align: center;
        }

        .date-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .date-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .date-label {
            display: block;
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 4px;
        }

        .date-value {
            font-size: 16px;
            font-weight: bold;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            flex: 1;
        }

        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-card .number {
            font-size: 36px;
            font-weight: bold;
        }

        .guests-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .guest-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .guest-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .guest-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .guest-name {
            font-size: 22px;
            font-weight: bold;
            color: #333;
        }

        .order-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .info-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 12px 0;
            color: #666;
        }

        .info-row .icon {
            width: 20px;
            text-align: center;
        }

        .info-row .label {
            font-weight: 500;
            min-width: 80px;
        }

        .info-row .value {
            color: #333;
            flex: 1;
        }

        .special-requests {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .special-requests h4 {
            font-size: 14px;
            color: #667eea;
            margin-bottom: 8px;
        }

        .special-requests ul {
            list-style: none;
            font-size: 14px;
            color: #666;
        }

        .special-requests li {
            margin: 5px 0;
        }

        .empty-state {
            text-align: center;
            background: white;
            padding: 60px 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .empty-state .emoji {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .empty-state h2 {
            color: #666;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #999;
        }

        .admin-notes {
            margin-top: 15px;
            padding: 15px;
            background: #fff9e6;
            border-radius: 10px;
            border-left: 4px solid #ffa500;
        }

        .admin-notes h4 {
            font-size: 14px;
            color: #ffa500;
            margin-bottom: 8px;
        }

        .admin-notes textarea {
            width: 100%;
            min-height: 60px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
            font-family: inherit;
            font-size: 14px;
        }

        .admin-notes textarea:focus {
            outline: none;
            border-color: #ffa500;
        }

        .admin-notes button {
            margin-top: 10px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #ffa500 0%, #ff7b00 100%);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: transform 0.2s;
        }

        .admin-notes button:hover {
            transform: translateY(-2px);
        }

        .save-status {
            display: inline-block;
            margin-left: 10px;
            font-size: 12px;
            color: #28a745;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- å°èˆªåˆ— -->
        <div class="nav-bar">
            <a href="/" class="nav-btn active">ğŸ“Š å…¥ä½ç®¡ç†</a>
            <a href="/rich-menu" class="nav-btn">ğŸ¨ Rich Menu ç®¡ç†</a>
        </div>


        <div class="header">
            <div class="header-top">
                <div>
                    <h1 data-i18n="title">ğŸ¨ å…¥ä½å®¢äººç®¡ç†</h1>
                    <p class="current-date" id="currentDate"></p>
                </div>
                <div class="lang-switcher">
                    <button class="lang-btn active" data-lang="zh-TW" onclick="switchLanguage('zh-TW')">ç¹é«”ä¸­æ–‡</button>
                    <button class="lang-btn" data-lang="id-ID" onclick="switchLanguage('id-ID')">Bahasa
                        Indonesia</button>
                </div>
            </div>

            <!-- æ—¥æœŸé¸æ“‡å™¨ -->
            <div class="date-selector" id="dateSelector"></div>

            <div class="stats">
                <div class="stat-card">
                    <h3 data-i18n="stat_orders">å…¥ä½è¨‚å–®</h3>
                    <div class="number" id="orderCount">{{ count }}</div>
                </div>
            </div>
        </div>

        <div id="guestsContainer">
            <div class="guests-grid" id="guestsGrid"></div>
        </div>
    </div>

    <script>
        // ç¿»è­¯å­—å…¸
        const translations = {
            'zh-TW': {
                title: 'ğŸ¨ å…¥ä½å®¢äººç®¡ç†',
                stat_orders: 'å…¥ä½è¨‚å–®',
                empty_title: 'ä»Šæ—¥æš«ç„¡å…¥ä½å®¢äºº',
                empty_desc: 'ç•¶å®¢äººé€é LINE Bot ç¢ºèªè¨‚å–®å¾Œï¼Œè³‡è¨Šæœƒè‡ªå‹•é¡¯ç¤ºåœ¨é€™è£¡',
                label_line_name: 'LINE å§“å',
                label_guest_name: 'è¨‚å–®å§“å',
                label_phone: 'è¯çµ¡é›»è©±',
                label_room_type: 'æˆ¿å‹',
                label_checkin: 'å…¥ä½æ—¥æœŸ',
                label_breakfast: 'æ—©é¤',
                label_source: 'è¨‚æˆ¿ä¾†æº',
                label_arrival: 'é è¨ˆæŠµé”',
                label_special: 'ç‰¹æ®Šéœ€æ±‚',
                label_notes: 'æ“ä½œäººå“¡å‚™è¨»',
                btn_save: 'å„²å­˜å‚™è¨»',
                status_saving: 'å„²å­˜ä¸­...',
                status_saved: 'âœ“ å·²å„²å­˜',
                status_error: 'âœ— å„²å­˜å¤±æ•—',
                breakfast_yes: 'å«æ—©é¤',
                breakfast_no: 'ä¸å«æ—©é¤',
                not_provided: 'æœªæä¾›',
                not_specified: 'æœªæŒ‡å®š',
                yesterday: 'æ˜¨å¤©',
                today: 'ä»Šå¤©',
                tomorrow: 'æ˜å¤©',
                placeholder_notes: 'è¼¸å…¥å…§éƒ¨å‚™è¨»ã€æ³¨æ„äº‹é …ç­‰...'
            },
            'id-ID': {
                title: 'ğŸ¨ Manajemen Tamu Check-in',
                stat_orders: 'Pesanan Check-in',
                empty_title: 'Belum Ada Tamu Check-in Hari Ini',
                empty_desc: 'Informasi akan muncul di sini setelah tamu mengkonfirmasi pesanan melalui LINE Bot',
                label_line_name: 'Nama LINE',
                label_guest_name: 'Nama Pemesanan',
                label_phone: 'Nomor Telepon',
                label_room_type: 'Tipe Kamar',
                label_checkin: 'Tanggal Check-in',
                label_breakfast: 'Sarapan',
                label_source: 'Sumber Pemesanan',
                label_arrival: 'Waktu Kedatangan',
                label_special: 'Permintaan Khusus',
                label_notes: 'Catatan Staf',
                btn_save: 'Simpan Catatan',
                status_saving: 'Menyimpan...',
                status_saved: 'âœ“ Tersimpan',
                status_error: 'âœ— Gagal Menyimpan',
                breakfast_yes: 'Termasuk Sarapan',
                breakfast_no: 'Tidak Termasuk Sarapan',
                not_provided: 'Tidak Disediakan',
                not_specified: 'Tidak Ditentukan',
                yesterday: 'Kemarin',
                today: 'Hari Ini',
                tomorrow: 'Besok',
                placeholder_notes: 'Masukkan catatan internal, hal yang perlu diperhatikan, dll...'
            }
        };

        let currentLang = localStorage.getItem('preferred-lang') || 'zh-TW';
        let currentDate = '{{ today }}';
        const initialCheckins = {{ checkins | tojson }};

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            generateDateButtons();
            switchLanguage(currentLang, false);
            updateCurrentDateDisplay();
            // è¼‰å…¥åˆå§‹è³‡æ–™
            if (initialCheckins && initialCheckins.length > 0) {
                renderGuestCards(initialCheckins);
            } else {
                showEmptyState();
            }
        });

        // ç”Ÿæˆæ—¥æœŸæŒ‰éˆ•ï¼ˆæ˜¨å¤©+ä»Šå¤©+æ˜å¤©+æœªä¾†6å¤©ï¼‰
        function generateDateButtons() {
            const container = document.getElementById('dateSelector');
            const today = new Date('{{ today }}');

            for (let i = -1; i < 8; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + i);

                const dateStr = date.toISOString().split('T')[0];
                const isActive = dateStr === currentDate;

                const btn = document.createElement('button');
                btn.className = 'date-btn' + (isActive ? ' active' : '');
                btn.setAttribute('data-date', dateStr);
                btn.onclick = () => loadCheckinsByDate(dateStr);

                const label = document.createElement('span');
                label.className = 'date-label';
                label.textContent = i === -1 ? translations[currentLang].yesterday :
                    (i === 0 ? translations[currentLang].today :
                        (i === 1 ? translations[currentLang].tomorrow : getWeekday(date)));

                const value = document.createElement('span');
                value.className = 'date-value';
                value.textContent = formatDate(date);

                btn.appendChild(label);
                btn.appendChild(value);
                container.appendChild(btn);
            }
        }

        // è¼‰å…¥æŒ‡å®šæ—¥æœŸçš„å…¥ä½è³‡æ–™
        async function loadCheckinsByDate(date) {
            currentDate = date;

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.date-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-date') === date);
            });

            // é¡¯ç¤ºè¼‰å…¥ä¸­
            const container = document.getElementById('guestsContainer');
            container.innerHTML = '<div class="loading">â³ ' + (currentLang === 'zh-TW' ? 'è¼‰å…¥ä¸­...' : 'Memuat...') + '</div>';

            try {
                const response = await fetch(`/api/checkins/${date}`);
                const data = await response.json();

                // æ›´æ–°çµ±è¨ˆ
                document.getElementById('orderCount').textContent = data.length;

                // æ›´æ–°å®¢äººåˆ—è¡¨
                renderGuestCards(data);
                updateCurrentDateDisplay();
            } catch (error) {
                console.error('Error loading checkins:', error);
                container.innerHTML = '<div class="empty-state"><h2>' +
                    (currentLang === 'zh-TW' ? 'è¼‰å…¥å¤±æ•—' : 'Gagal Memuat') +
                    '</h2></div>';
            }
        }

        // æ¸²æŸ“å®¢äººå¡ç‰‡
        function renderGuestCards(guests) {
            const container = document.getElementById('guestsContainer');

            if (guests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">ğŸ‰</div>
                        <h2 data-i18n="empty_title">${translations[currentLang].empty_title}</h2>
                        <p data-i18n="empty_desc">${translations[currentLang].empty_desc}</p>
                    </div>
                `;
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'guests-grid';
            grid.id = 'guestsGrid';

            guests.forEach(guest => {
                const card = createGuestCard(guest);
                grid.appendChild(card);
            });

            container.innerHTML = '';
            container.appendChild(grid);
        }

        // é¡¯ç¤ºç©ºç‹€æ…‹
        function showEmptyState() {
            const container = document.getElementById('guestsContainer');
            const t = translations[currentLang];
            container.innerHTML = `
                <div class="empty-state">
                    <div class="emoji">ğŸ‰</div>
                    <h2 data-i18n="empty_title">${t.empty_title}</h2>
                    <p data-i18n="empty_desc">${t.empty_desc}</p>
                </div>
            `;
        }

        // å‰µå»ºå®¢äººå¡ç‰‡
        function createGuestCard(guest) {
            const card = document.createElement('div');
            card.className = 'guest-card';

            const t = translations[currentLang];

            card.innerHTML = `
                <div class="guest-header">
                    <div class="guest-name">${guest.guest_name || t.not_provided}</div>
                    <div class="order-badge">#${guest.order_id}</div>
                </div>
                
                <div class="info-row">
                    <span class="icon">ğŸ“…</span>
                    <span class="label" data-i18n="label_checkin">${t.label_checkin}</span>
                    <span class="value">${guest.check_in} - ${guest.check_out}</span>
                </div>
                
                <div class="info-row">
                    <span class="icon">ğŸ </span>
                    <span class="label" data-i18n="label_room_type">${t.label_room_type}</span>
                    <span class="value">${guest.room_type || t.not_specified} Ã— ${guest.room_count || 1}</span>
                </div>
                
                <div class="info-row">
                    <span class="icon">ğŸ“±</span>
                    <span class="label" data-i18n="label_phone">${t.label_phone}</span>
                    <span class="value">${guest.phone || t.not_provided}</span>
                </div>
                
                <div class="info-row">
                    <span class="icon">ğŸ³</span>
                    <span class="label" data-i18n="label_breakfast">${t.label_breakfast}</span>
                    <span class="value">${guest.breakfast ? t.breakfast_yes : t.breakfast_no}</span>
                </div>
                
                <div class="info-row">
                    <span class="icon">ğŸŒ</span>
                    <span class="label" data-i18n="label_source">${t.label_source}</span>
                    <span class="value">${guest.booking_source || t.not_provided}</span>
                </div>
                
                ${guest.line_display_name ? `
                <div class="info-row">
                    <span class="icon">ğŸ‘¤</span>
                    <span class="label" data-i18n="label_line_name">${t.label_line_name}</span>
                    <span class="value">${guest.line_display_name}</span>
                </div>
                ` : ''}
                
                ${guest.arrival_time ? `
                <div class="info-row">
                    <span class="icon">ğŸ•</span>
                    <span class="label" data-i18n="label_arrival">${t.label_arrival}</span>
                    <span class="value">${guest.arrival_time}</span>
                </div>
                ` : ''}
                
                ${guest.special_requests && guest.special_requests.length > 0 ? `
                <div class="special-requests">
                    <h4 data-i18n="label_special">ğŸ”” ${t.label_special}</h4>
                    <ul>
                        ${guest.special_requests.map(req => `<li>â€¢ ${req}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
                
                <div class="admin-notes">
                    <h4 data-i18n="label_notes">ğŸ“ ${t.label_notes}</h4>
                    <textarea id="notes-${guest.order_id}" 
                        placeholder="${t.placeholder_notes}">${guest.admin_notes || ''}</textarea>
                    <button onclick="saveNotes('${guest.order_id}')" data-i18n="btn_save">${t.btn_save}</button>
                    <span id="status-${guest.order_id}" class="save-status"></span>
                </div>
            `;

            return card;
        }

        // åˆ‡æ›èªè¨€
        function switchLanguage(lang, reload = true) {
            currentLang = lang;
            localStorage.setItem('preferred-lang', lang);

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-lang') === lang);
            });

            // æ›´æ–°æ‰€æœ‰ç¿»è­¯æ–‡å­—
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = translations[lang][key];
                    } else {
                        el.textContent = translations[lang][key];
                    }
                }
            });

            // é‡æ–°è¼‰å…¥è³‡æ–™ä»¥æ›´æ–°å¡ç‰‡å…§å®¹
            if (reload && document.getElementById('guestsGrid')) {
                loadCheckinsByDate(currentDate);
            }

            // æ›´æ–°æ—¥æœŸæŒ‰éˆ•æ¨™ç±¤
            updateDateButtonLabels();
        }

        // æ›´æ–°æ—¥æœŸæŒ‰éˆ•æ¨™ç±¤
        function updateDateButtonLabels() {
            const buttons = document.querySelectorAll('.date-btn');
            buttons.forEach((btn, index) => {
                const label = btn.querySelector('.date-label');
                if (index === 0) {
                    label.textContent = translations[currentLang].yesterday;
                } else if (index === 1) {
                    label.textContent = translations[currentLang].today;
                } else if (index === 2) {
                    label.textContent = translations[currentLang].tomorrow;
                } else {
                    const dateStr = btn.getAttribute('data-date');
                    const date = new Date(dateStr);
                    label.textContent = getWeekday(date);
                }
            });
        }

        // æ›´æ–°ç•¶å‰æ—¥æœŸé¡¯ç¤º
        function updateCurrentDateDisplay() {
            const dateEl = document.getElementById('currentDate');
            dateEl.textContent = currentDate;
        }

        // å„²å­˜å‚™è¨»
        function saveNotes(orderId) {
            const textarea = document.getElementById('notes-' + orderId);
            const statusSpan = document.getElementById('status-' + orderId);
            const notes = textarea.value;
            const t = translations[currentLang];

            statusSpan.textContent = t.status_saving;
            statusSpan.style.color = '#999';

            fetch('/api/order/' + orderId + '/notes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notes: notes })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        statusSpan.textContent = t.status_saved;
                        statusSpan.style.color = '#28a745';
                        setTimeout(() => { statusSpan.textContent = ''; }, 3000);
                    } else {
                        statusSpan.textContent = t.status_error;
                        statusSpan.style.color = '#dc3545';
                    }
                })
                .catch(error => {
                    statusSpan.textContent = t.status_error;
                    statusSpan.style.color = '#dc3545';
                    console.error('Error:', error);
                });
        }

        // è¼”åŠ©å‡½æ•¸
        function formatDate(date) {
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${month}/${day}`;
        }

        function getWeekday(date) {
            const weekdays = currentLang === 'zh-TW'
                ? ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­']
                : ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
            return weekdays[date.getDay()];
        }
    </script>

    <!-- ç•™è¨€æ¿çµ„ä»¶ -->
    {% include 'message_board_component.html' %}

</body>

</html>